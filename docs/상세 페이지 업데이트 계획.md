# 종목 상세 페이지 업데이트 계획

## 1. 개요

### 1.1 목표
- 종목 상세 페이지(`/stock-detail/[symbol]`)를 PostgreSQL 데이터와 연결
- 하드코딩된 데이터를 실제 DB 데이터로 대체
- 한국/미국 종목 자동 구분 및 표시

### 1.2 URL 구조
```
/stock-detail/{symbol}

예시:
/stock-detail/005930  → 삼성전자 (한국)
/stock-detail/AAPL    → Apple (미국)
```

### 1.3 종목 조회 로직
```
1. symbol 첫 글자 확인
2. 숫자로 시작 → KR 먼저 검색 → 없으면 US 검색
3. 영어로 시작 → US 먼저 검색 → 없으면 KR 검색
4. 양쪽 모두 없음 → 404 페이지
```

---

## 2. 완료된 작업

| 작업 | 상태 | 비고 |
|------|------|------|
| drizzle.config.ts 수정 | 완료 | 새 테이블 필터 추가 |
| 스키마 pull | 완료 | kr_stock_basic, us_stock_basic, kr_stock_grade, us_stock_grade, kr_intraday_total |
| timestamp mode 복원 | 완료 | 'string' → 'date' |
| stock.ts 서버 함수 생성 | 완료 | getStockBySymbol, getStockGrade, getStockDetail, getStockPrice, getStockChartData |
| 사용하지 않는 파일 삭제 | 완료 | stock-data.ts, stock-formatters.ts, __(home)__no-use 폴더 |
| AI 종합 의견 섹션 구현 | 완료 | signalOverall, timeSeriesText, riskProfileText + 핵심 지표 테이블 |
| 종합 평가 등급 섹션 구현 | 완료 | finalGrade, valueScore, qualityScore, momentumScore, growthScore |
| 시나리오별 목표가 및 대응 방안 구현 | 완료 | strategy 컬럼 연동 (시나리오, 기술적 분석, 시장 환경) |
| 대체 종목 제안 구현 | 완료 | altSymbol, altStockName, altFinalGrade, altReasons 연동 |
| 숫자 콤마 포맷 | 완료 | 4자리 이상 숫자에 자동 콤마 추가 (formatNumbersInText) |
| 차트 API 구현 | 완료 | /api/stock/chart - kr_intraday_total 테이블 연동 |
| 차트 X축 틱 설정 | 완료 | 기간별 틱 개수: 1주(전체), 1개월(5), 3개월(4), 6개월(4), 1년(5) |
| 차트 UI 개선 | 완료 | 점 제거(매끄러운 선), 툴팁 간격 조정 |
| 차트 API 캐싱 | 완료 | 한국 16:15, 미국 07:30 기준 24시간 캐싱 (브라우저 + CDN) |
| 페이지 UX 개선 | 완료 | 텍스트 선택 비활성화, 클릭 가능 요소 커서 포인터 |
| 미국 종목 지원 | 완료 | 차트 + 페이지 데이터 모두 한국/미국 종목 지원 |
| us_stock_basic 컬럼명 수정 | 완료 | week52high, week52low, day50movingaverage, day200movingaverage |
| Grade 데이터 캐싱 | 완료 | 한국 20:30, 미국 13:00 기준 24시간 캐싱 (unstable_cache) |
| Grade API 생성 | 완료 | /api/stock/grade - 외부 서비스용 (브라우저 + CDN 캐싱) |
| formatNumbersInText null 처리 | 완료 | undefined/null 입력 시 '-' 반환 |

---

## 3. 남은 작업

### Phase 2: 상세페이지 데이터 연결

#### 3.1 UI 영역별 데이터 매핑

| UI 섹션 | 현재 하드코딩 값 | 매핑할 테이블.컬럼 | 상태 |
|---------|-----------------|-------------------|------|
| **헤더** | | | |
| - 종목명 | "삼성전자" | `kr_stock_basic.stockName` / `us_stock_basic.stockName` | 완료 |
| - 시장 | "KOSPI (005930)" | `kr_stock_basic.exchange` / `us_stock_basic.exchange` + symbol | 완료 |
| - 좋아요 버튼 | - | `favorites` 테이블 연동 | 미완료 |
| **현재가 섹션** | | | |
| - 현재 가격 | "110,500원" | `kr_intraday.close` / `us_daily.close` | 완료 |
| - 등락률 | "+3.95%" | `kr_intraday.changeRate` / `us_daily.changeRate` | 완료 |
| - 차트 데이터 | 하드코딩 배열 | `kr_intraday_total` (API: /api/stock/chart) | 완료 |
| **AI 종합 의견** | | | |
| - 종합 시그널 | 하드코딩 텍스트 | `signalOverall` | 완료 |
| - 시계열 분석 | - | `timeSeriesText` | 완료 |
| - 리스크 프로파일 | - | `riskProfileText` | 완료 |
| - 변동성 | - | `volatilityAnnual` | 완료 |
| - 최대 낙폭 | - | `maxDrawdown1Y` | 완료 |
| - VaR 95% | - | `var95` | 완료 |
| - CVaR 95% | - | `cvar95` | 완료 |
| - 베타 | - | `beta` | 완료 |
| - 섹터 모멘텀 | - | `sectorMomentum` | 완료 |
| - RS 값/순위 | - | `rsValue`, `rsRank` | 완료 |
| - 업종 순위 | - | `industryRank` | 완료 |
| - 섹터 순위 | - | `sectorRank` | 완료 |
| **종합 평가 등급** | | | |
| - 투자 등급 | "강한 매수" | `finalGrade` | 완료 |
| - 가치 (value) | 75.5 | `valueScore`, `valueRank` | 완료 |
| - 우수함 (quality) | 68.2 | `qualityScore`, `qualityRank` | 완료 |
| - 탄력 (momentum) | 82.1 | `momentumScore`, `momentumRank` | 완료 |
| - 성장 (growth) | 71.3 | `growthScore`, `growthRank` | 완료 |
| **시나리오별 목표가** | | | |
| - 시나리오 데이터 | 하드코딩 | `strategy` (JSONB) | 완료 |
| - 강세/횡보/약세 시나리오 | - | `strategy.scenarios` | 완료 |
| - 기술적 분석 | - | `strategy.technical_summary` | 완료 |
| - 시장 환경 | - | `strategy.market_environment` | 완료 |
| - 메인 시나리오 표시 | - | 확률 기반 자동 계산 | 완료 |
| **대체 종목 제안** | | | |
| - 대체 종목코드 | - | `altSymbol` | 완료 |
| - 대체 종목명 | - | `altStockName` | 완료 |
| - 대체 종목 등급 | - | `altFinalGrade` | 완료 |
| - 추천 이유 | - | `altReasons` (JSON) | 완료 |

---

### 3.2 확인이 필요한 사항

#### Q1: 현재가/등락률/차트 데이터 소스
현재 `kr_stock_basic`, `us_stock_basic`, `kr_stock_grade`, `us_stock_grade` 테이블에는 **실시간 가격 데이터가 없음**.

**선택지:**
- A: 추가 테이블 연결 (`kr_intraday_total`, `us_daily` 등)
- B: 가격 섹션 일단 제외하고 분석 데이터만 표시
- C: 다른 방법

#### Q2: 점수 매핑 (확정)

| UI 항목 | DB 컬럼 | 상태 |
|---------|---------|------|
| 가치 (value) | `valueScore` | 확정 |
| 우수함 (quality) | `qualityScore` | 확정 |
| 탄력 (momentum) | `momentumScore` | 확정 |
| 성장 (growth) | `growthScore` | 확정 |

#### Q3: 점수 스케일
- DB 점수: 0-100 스케일 (예: 75.5)
- UI 표시: 그대로 사용 (변환 없음)

---

### Phase 2.5: AI 종합 의견 섹션 구현

#### 사용할 DB 컬럼

| 컬럼명 | 타입 | 설명 | 예시 데이터 (삼성전자) |
|--------|------|------|----------------------|
| signalOverall | TEXT | 종합 시그널 | "긍정적 신호 우세 - 매수 검토 구간" |
| timeSeriesText | TEXT | 시계열 분석 | "팩터 혼재 양상, 기관/외국인 동반 매수 (긍정적)" |
| riskProfileText | TEXT | 리스크 프로파일 | "중위험 프로파일 - 변동성 매우 높음 (46.2%)..." |
| volatilityAnnual | NUMERIC | 연간 변동성 | 46.2 |
| maxDrawdown1Y | NUMERIC | 1년 최대 낙폭 | -14.67 |
| beta | NUMERIC | 베타 | 1.92 |
| industryRank | INTEGER | 업종 내 순위 | 1 |
| industryPercentile | NUMERIC | 업종 내 백분위 | 100.0 |
| sectorRank | INTEGER | 섹터 내 순위 | 4 |
| sectorPercentile | NUMERIC | 섹터 내 백분위 | 23.53 |

#### UI 설계 (방안 B)

```
┌─────────────────────────────────────────────────┐
│ AI 종합 의견                                      │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ {signalOverall}                             │ │  ← 강조 박스
│ │ 예: 긍정적 신호 우세 - 매수 검토 구간        │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ {timeSeriesText}                                │  ← 일반 텍스트
│ 예: 팩터 혼재 양상, 기관/외국인 동반 매수       │
│                                                 │
│ {riskProfileText 요약}                          │  ← 일반 텍스트
│ 예: 중위험 프로파일 - 변동성 높음, 낙폭 보통    │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ 리스크 지표                                  │ │
│ │ ┌───────────┬───────────┬─────────┐        │ │
│ │ │ 변동성    │ 최대낙폭   │ 베타    │        │ │
│ │ │  46.2%   │  -14.7%   │  1.92  │        │ │
│ │ └───────────┴───────────┴─────────┘        │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ 시장 순위                                    │ │
│ │ ┌─────────────────┬─────────────────┐      │ │
│ │ │ 업종 1위 (100%) │ 섹터 4위 (24%)  │      │ │
│ │ └─────────────────┴─────────────────┘      │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

#### 대안 (방안 C - 필요시 전환)

```
┌─────────────────────────────────────────────────┐
│ AI 종합 의견                                      │
├─────────────────────────────────────────────────┤
│ [종합 시그널]                                    │
│ ┌─────────────────────────────────────────────┐ │
│ │ 긍정적 신호 우세 - 매수 검토 구간             │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ [시장 분석]                                      │
│ 팩터 혼재 양상, 기관/외국인 동반 매수 (긍정적)   │
│                                                 │
│ [리스크 분석]                                    │
│ 중위험 프로파일                                  │
│ • 변동성: 46.2% (매우 높음)                      │
│ • 최대 낙폭: -14.7%                             │
│ • 베타: 1.92                                    │
│                                                 │
│ [시장 순위]                                      │
│ • 업종 내: 1위 (상위 100%)                       │
│ • 섹터 내: 4위 (상위 24%)                        │
└─────────────────────────────────────────────────┘
```

#### 구현 작업

| 단계 | 작업 | 상태 |
|------|------|------|
| 1 | stock.ts에 AI 의견 관련 컬럼 조회 추가 | 완료 |
| 2 | page.tsx AI 종합 의견 섹션 UI 구현 (방안 B) | 완료 |
| 3 | null 값 처리 ('-' 또는 섹션 숨김) | 완료 |
| 4 | UI 검토 후 필요시 방안 C로 전환 | 불필요 (방안 B로 확정) |

---

### Phase 3: 종목 링크 시스템

| 작업 | 설명 | 상태 |
|------|------|------|
| StockLink 컴포넌트 생성 | 재사용 가능한 종목명 링크 컴포넌트 | 미완료 |
| 기존 페이지 적용 | 종목명 클릭 시 상세페이지 이동 | 미완료 |

```tsx
// 예상 사용법
<StockLink symbol="005930" name="삼성전자" />
<StockLink symbol="AAPL" name="Apple" />
```

---

### Phase 4: 검색 기능

| 작업 | 설명 | 상태 |
|------|------|------|
| 검색 API 구현 | 종목명/코드로 검색 | 미완료 |
| 검색창 UI | discover/find 페이지에 추가 | 미완료 |
| 자동완성 | 검색어 입력 시 후보 표시 | 미완료 |
| 검색 결과 연결 | 클릭 시 상세페이지 이동 | 미완료 |

**검색창 위치:**
```
┌─────────────────────────────────────────┐
│ [포트폴리오 리스트]  [종목 찾기]           │
├─────────────────────────────────────────┤
│ [검색창 UI 위치]                          │  ← 여기
├─────────────────────────────────────────┤
│ 오늘의 추천주            [KR 한국] [US]  │
└─────────────────────────────────────────┘
```

---

## 4. 사용 가능한 테이블 및 컬럼

### 4.1 kr_stock_basic (한국 종목 기본정보)
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| symbol | VARCHAR(10) PK | 종목코드 |
| stockName | VARCHAR(200) | 종목명 |
| stockNameEng | VARCHAR(200) | 영문 종목명 |
| exchange | VARCHAR(20) | 시장 (KOSPI/KOSDAQ) |
| listedDate | DATE | 상장일 |
| securitiesType | VARCHAR(200) | 증권구분 |
| department | VARCHAR(200) | 소속부 |
| stockType | VARCHAR(200) | 주식종류 |
| parValue | BIGINT | 액면가 |
| listedShares | BIGINT | 상장주식수 |
| aliases | TEXT[] | 종목 별칭 |

### 4.2 us_stock_basic (미국 종목 기본정보)
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| symbol | VARCHAR(10) PK | 종목코드 |
| stockName | TEXT | 종목명 |
| stockNameKr | VARCHAR(100) | 한글 종목명 |
| exchange | VARCHAR(10) | 거래소 (NASDAQ/NYSE) |
| sector | VARCHAR(50) | 산업 부문 |
| industry | VARCHAR(100) | 산업 분야 |
| marketCap | BIGINT | 시가총액 |
| per | NUMERIC | PER |
| eps | NUMERIC | EPS |
| beta | NUMERIC | 베타 |
| week52High | NUMERIC | 52주 최고가 |
| week52Low | NUMERIC | 52주 최저가 |
| isActive | BOOLEAN | 거래 가능 여부 |
| aliases | TEXT[] | 종목 별칭 |

### 4.3 kr_stock_grade (한국 종목 분석결과)
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| symbol | VARCHAR(10) | 종목코드 (PK) |
| date | DATE | 분석 날짜 (PK) |
| stockName | VARCHAR(200) | 종목명 |
| finalGrade | VARCHAR(20) | 투자 등급 (강력 매수, 매수, 중립 등) |
| finalScore | NUMERIC(5,1) | 최종 점수 (0-100) |
| valueScore | NUMERIC(5,1) | 가치 점수 |
| qualityScore | NUMERIC(5,1) | 품질 점수 |
| momentumScore | NUMERIC(5,1) | 모멘텀 점수 |
| growthScore | NUMERIC(5,1) | 성장 점수 |
| confidenceScore | NUMERIC(5,1) | 신뢰도 점수 |
| industryRank | INTEGER | 업종 내 순위 |
| industryPercentile | NUMERIC(5,1) | 업종 내 백분위 |
| scenarioBullishProb | INTEGER | 강세 확률 (%) |
| scenarioSidewaysProb | INTEGER | 횡보 확률 (%) |
| scenarioBearishProb | INTEGER | 약세 확률 (%) |
| scenarioBullishReturn | VARCHAR(20) | 강세 시 수익률 범위 |
| scenarioSidewaysReturn | VARCHAR(20) | 횡보 시 수익률 범위 |
| scenarioBearishReturn | VARCHAR(20) | 약세 시 수익률 범위 |
| buyTriggers | JSONB | 매수 조건 |
| sellTriggers | JSONB | 매도 조건 |
| holdTriggers | JSONB | 보유 조건 |
| strategy | JSONB | AI 전략 분석 결과 |
| altSymbol | VARCHAR(10) | 대체 종목코드 |
| altStockName | VARCHAR(200) | 대체 종목명 |
| altFinalGrade | VARCHAR(20) | 대체 종목 등급 |
| altFinalScore | NUMERIC(5,1) | 대체 종목 점수 |
| altMatchType | VARCHAR(20) | 대체 종목 매칭 타입 |
| altReasons | JSONB | 대체 추천 이유 |

### 4.4 us_stock_grade (미국 종목 분석결과)
kr_stock_grade와 동일한 구조 (일부 컬럼 차이 있음)

---

## 5. 파일 구조

```
src/
├── lib/
│   └── server/
│       └── stock.ts          # 종목 조회 함수 (완료)
│           ├── getStockBySymbol()
│           ├── getStockGrade()
│           └── getStockDetail()
│
├── app/
│   └── (service)/
│       ├── stock-detail/
│       │   └── [stockId]/
│       │       └── page.tsx  # 상세페이지 (수정 예정)
│       │
│       └── discover/
│           └── find/
│               └── page.tsx  # 검색창 추가 예정
│
└── components/
    └── shared/
        └── stock-link.tsx    # 종목 링크 컴포넌트 (생성 예정)
```

---

## 6. 다음 단계

1. **Q1, Q2, Q3 확인** - 데이터 매핑 결정
2. **Phase 2 진행** - 상세페이지 데이터 연결
3. **Phase 3 진행** - StockLink 컴포넌트
4. **Phase 4 진행** - 검색 기능

---

## 7. 변경 이력

| 날짜 | 작업 내용 |
|------|----------|
| 2026-01-19 | 계획서 초안 작성 |
| 2026-01-19 | Phase 1 완료 (스키마, 서버 함수) |
| 2026-01-19 | 종합 평가 등급 UI 변경 - 4개 항목으로 축소 (가치, 우수함, 탄력, 성장) |
| 2026-01-19 | 점수 매핑 확정 (valueScore, qualityScore, momentumScore, growthScore) |
| 2026-01-19 | 종합 평가 등급 섹션 UI 구현 완료 (헤더 행 추가, 같은 줄 레이아웃) |
| 2026-01-19 | Phase 2 완료 - DB 연결 (kr_intraday, us_daily, 순위 컬럼 추가) |
| 2026-01-19 | stock.ts 업데이트 - getStockPrice 함수 추가, getStockDetail에 price 포함 |
| 2026-01-19 | page.tsx DB 연결 완료 - 헤더, 가격, 종합 평가 등급 섹션 |
| 2026-01-19 | null 값 처리 구현 - 데이터 없을 시 '-' 표시 |
| 2026-01-19 | Phase 2.5 계획 추가 - AI 종합 의견 섹션 (방안 B, 필요시 C로 전환) |
| 2026-01-20 | AI 종합 의견 섹션 구현 완료 - 핵심 지표 테이블 포함 (10개 지표) |
| 2026-01-20 | 시나리오별 목표가 및 대응 방안 구현 완료 - strategy JSONB 연동 |
| 2026-01-20 | - 3개 시나리오 (강세/횡보/약세) 상세 정보 표시 |
| 2026-01-20 | - 기술적 분석 섹션 (RSI, ADX, MA, 볼린저밴드, 수급 등) |
| 2026-01-20 | - 시장 환경 섹션 (VIX, 금리, 시장 국면 등) |
| 2026-01-20 | - 메인 시나리오 자동 표시 (확률 기반) |
| 2026-01-20 | 대체 종목 제안 구현 완료 - altSymbol, altStockName, altFinalGrade, altReasons 연동 |
| 2026-01-20 | 숫자 콤마 포맷 함수 추가 - 4자리 이상 숫자 자동 콤마 (formatNumbersInText) |
| 2026-01-20 | UI 스타일 조정 - 날짜/메인 시나리오 글씨 크기 (variant s2) |
| 2026-01-21 | 차트 API 구현 - /api/stock/chart, kr_intraday_total 테이블 연동 |
| 2026-01-21 | 차트 X축 틱 설정 - getXAxisTicks 함수 (1주:전체, 1개월:5, 3개월:4, 6개월:4, 1년:5) |
| 2026-01-21 | 차트 UI 개선 - 점 제거(dot=false), 마우스오버 시만 점 표시(activeDot) |
| 2026-01-21 | 차트 툴팁 포맷 변경 - 날짜와 가격 사이 간격 조정 (flex gap-3) |
| 2026-01-21 | 차트 API 캐싱 구현 - 16:15 기준 24시간 캐싱 (max-age + s-maxage) |
| 2026-01-21 | 페이지 텍스트 선택 비활성화 - select-none 적용 |
| 2026-01-21 | 클릭 가능 요소 커서 변경 - cursor-pointer (뒤로가기, 좋아요, 기간 버튼) |
| 2026-01-21 | 차트 API 디버그 로그 제거 |
| 2026-01-21 | 미국 종목 차트 지원 - us_daily 테이블 연동, market 파라미터 추가 |
| 2026-01-21 | us_stock_basic 컬럼명 수정 - PostgreSQL 소문자 컬럼명 매핑 |
| 2026-01-21 | 차트 API 캐싱 개선 - 한국 16:15, 미국 07:30 기준 분리 |
| 2026-01-21 | Grade 데이터 캐싱 구현 - 한국 20:30, 미국 13:00 기준 (unstable_cache) |
| 2026-01-21 | Grade API 생성 - /api/stock/grade (외부 서비스용, Cache-Control) |
| 2026-01-21 | formatNumbersInText null 처리 - 미국 종목 strategy 필드 undefined 대응 |

---

## 8. 앞으로 해야 할 작업

### Phase 2.6: 시나리오별 목표가 및 대응 방안 업데이트 (최우선)

#### 개요
- 캐시 만료 시 "업데이트" 버튼을 통해 AI 분석 데이터 생성 트리거
- 동시 요청 시 중복 실행 방지 (Redis Lock)
- 생성 완료 시 모든 사용자에게 결과 표시
- **Railway 배포 환경에서만 개발 및 테스트**

#### UI 상태 (4가지)

| 상태 | 조건 | 화면 표시 |
|------|------|----------|
| 정보 표시 | strategy 데이터 존재 + 최신 date | 현재와 동일 (시나리오 정보) |
| 업데이트 대기 | strategy가 NULL 또는 date가 오래됨 | 제목 + "업데이트" 버튼 |
| 생성 중 | Redis Lock 존재 | 제목 + Bar Chart 로딩 애니메이션 (빨간색) + 메시지 |
| 실패 | 3회 시도 모두 실패 | 제목 + 에러 메시지 + "다시 시도" 버튼 |

#### 데이터 신선도 판단

**최신 데이터 날짜 기준:**

| 시점 (한국 시간) | 한국 종목 예상 date | 미국 종목 예상 date |
|------------------|---------------------|---------------------|
| 월~금 20:30 이전 | 전 거래일 | 전전 거래일 (미국 기준) |
| 월~금 20:30 이후 | 당일 | 전 거래일 (미국 기준) |
| 토요일 13:00 이전 | 금요일 | 목요일 (미국 기준) |
| 토요일 13:00 이후 | 금요일 | 금요일 (미국 기준) |
| 일요일 전체 | 금요일 | 금요일 (미국 기준) |

**공휴일 처리:** 추후 업데이트 예정 (현재는 주말만 처리)

#### 시스템 아키텍처

```
Railway 배포 환경:

Worker #1 (client)     Worker #2 (api)      Worker #3 (stock_agents)
Next.js           -->  FastAPI         -->  Python Worker
Port: 3000             Port: 8000           Port: 8001
        |                    |                    |
        |                    v                    |
        |              +---------+                |
        |              |  Redis  |                |
        |              | (Lock)  |                |
        |              +---------+                |
        |                    |                    |
        +--------------------+--------------------+
                             |
                             v
                      +------------+
                      | PostgreSQL |
                      +------------+
```

#### API 설계

**FastAPI (C:\project\alpha_front\api):**

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/scenario/generate` | 생성 트리거 (Redis Lock 획득) |
| GET | `/api/scenario/status/{symbol}` | 상태 조회 |

**stock_agents Worker (C:\project\alpha\stock_agents):**

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/run/{market}/{symbol}` | 스크립트 실행 (kr_main.py / us_main.py) |

#### 동시성 제어 (Redis Lock)

- Lock 키: `scenario:generating:{symbol}`
- TTL: 5분 (자동 만료)
- 첫 번째 요청만 Lock 획득 후 스크립트 실행
- 이후 요청은 "생성 중" 상태로 대기

#### 재시도 정책

- 자동 재시도: 3회 (초기 1회 + 재시도 2회)
- 재시도 간격: 5초
- 최종 실패 시: "다시 시도" 버튼 표시

#### 프론트엔드 폴링

- 폴링 간격: 3초
- 최대 대기 시간: 5분
- 완료/실패 감지 시 폴링 중단

#### 구현 작업 목록

**Phase 2.6-1: stock_agents Worker API (C:\project\alpha\stock_agents)**

| 순서 | 작업 | 파일 |
|------|------|------|
| 1-1 | FastAPI 앱 생성 | `api.py` |
| 1-2 | 실행 엔드포인트 | `api.py` - `POST /run/{market}/{symbol}` |
| 1-3 | Redis 연결 (Lock 해제용) | `api.py` |
| 1-4 | 재시도 로직 (3회, 5초 간격) | `api.py` |
| 1-5 | Railway 배포 설정 | `Procfile`, `requirements.txt` |

**Phase 2.6-2: FastAPI 백엔드 (C:\project\alpha_front\api)**

| 순서 | 작업 | 파일 |
|------|------|------|
| 2-1 | 시나리오 라우터 생성 | `app/routers/scenario.py` |
| 2-2 | 생성 트리거 API | `POST /api/scenario/generate` |
| 2-3 | 상태 조회 API | `GET /api/scenario/status/{symbol}` |
| 2-4 | Redis Lock 로직 | `app/services/scenario.py` |
| 2-5 | 데이터 신선도 체크 | `app/services/scenario.py` |
| 2-6 | Worker 호출 로직 | `app/services/scenario.py` |

**Phase 2.6-3: Frontend (C:\project\alpha_front\client)**

| 순서 | 작업 | 파일 |
|------|------|------|
| 3-1 | 시나리오 섹션 분리 | `_components/scenario-section.tsx` (Client Component) |
| 3-2 | Bar Chart 로딩 애니메이션 | `_components/scenario-loading.tsx` (빨간색 #ef4444) |
| 3-3 | API 호출 함수 | `lib/api/scenario.ts` |
| 3-4 | 상태 관리 + 폴링 로직 | `scenario-section.tsx` |
| 3-5 | 업데이트/재시도 버튼 UI | `scenario-section.tsx` |
| 3-6 | 페이지 통합 | `page.tsx` |

**Phase 2.6-4: 통합 테스트 (Railway 환경)**

| 순서 | 작업 |
|------|------|
| 4-1 | 단일 사용자 정상 흐름 |
| 4-2 | 동시 요청 (여러 탭) |
| 4-3 | 타임아웃 (5분 초과) |
| 4-4 | 실패/재시도 |
| 4-5 | 캐시 만료 (날짜 변경) |

#### 추후 업데이트 예정

| 항목 | 설명 |
|------|------|
| 공휴일 처리 | 한국/미국 공휴일 캘린더 연동 |
| 로컬 개발 환경 | subprocess 직접 실행 방식 |
| 실시간 진행률 | WebSocket으로 진행 상황 표시 |

---

### 기타 필요
| 작업 | 우선순위 | 설명 |
|------|----------|------|
| 좋아요 기능 구현 | 중간 | favorites 테이블 연동, 상태 토글 |

### Phase 3: 종목 링크 시스템
| 작업 | 우선순위 | 설명 |
|------|----------|------|
| StockLink 컴포넌트 생성 | 중간 | 재사용 가능한 종목명 링크 |
| 기존 페이지 적용 | 중간 | discover/find 등에서 종목 클릭 시 상세페이지 이동 |
| 대체 종목 링크 연결 | 중간 | 대체 종목 클릭 시 해당 상세페이지로 이동 |

### Phase 4: 검색 기능
| 작업 | 우선순위 | 설명 |
|------|----------|------|
| 검색 API 구현 | 낮음 | 종목명/코드로 검색 |
| 검색창 UI | 낮음 | discover/find 페이지에 추가 |
| 자동완성 | 낮음 | 검색어 입력 시 후보 표시 |

### 기타 개선사항
| 작업 | 우선순위 | 설명 |
|------|----------|------|
| 에러 핸들링 강화 | 낮음 | 차트 데이터 로드 실패 시 사용자 피드백 |
| 로딩 스켈레톤 | 낮음 | 차트 로딩 중 UI 개선 |

---

## 9. 캐싱 구조

### 9.1 캐싱 기준 시간

| 구분 | 한국 (KR) | 미국 (US) |
|------|-----------|-----------|
| 차트 데이터 | 16:15 | 07:30 |
| Grade 데이터 (AI 의견, 등급, 시나리오, 대체 종목) | 20:30 | 13:00 |

### 9.2 캐싱 레이어

| 레이어 | 대상 | 설명 |
|--------|------|------|
| 브라우저 캐시 (max-age) | 같은 사용자, 같은 브라우저 | 로컬 저장 |
| CDN 캐시 (s-maxage) | 모든 사용자 | Vercel Edge 캐시 |
| 서버 캐시 (unstable_cache) | Server Component | Next.js 서버 메모리 |

### 9.3 적용 현황

| 데이터 | 호출 방식 | 캐싱 방식 |
|--------|----------|----------|
| 차트 | Client Component → `/api/stock/chart` | max-age + s-maxage |
| 페이지 데이터 | Server Component → `getStockDetailCached()` | unstable_cache |
| (예비) Grade API | `/api/stock/grade` | max-age + s-maxage |
